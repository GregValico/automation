name: Bootstrap GKE cluster

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Name of the GCP Project'
        required: true
      cluster_name:
        description: 'Name of GKE cluster'
        required: true
      subnet_name:
        description: 'Node subnet name'
        required: true
      region:
        description: 'Region of the GKE cluster'
        required: true
        type: choice
        options:
          - us-east4

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          version: 'latest'

      # - name: Install gcloud beta components
      #   run: |
      #     sudo apt-get update && sudo apt-get install -y apt-transport-https ca-certificates gnupg
      #     echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      #     sudo apt-get install -y google-cloud-sdk
      #     gcloud components install beta --quiet

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ inputs.project_name }}

      - name: SSH and Install Jump Tools 
        run: |
          gcloud compute ssh --zone "${{ inputs.region }}-a" "gke-jump-${{ inputs.cluster_name }}" --project "${{ inputs.project_name }}" --command '
            # sleep 20
            # sudo apt-get update && sudo apt-get install -y apt-transport-https ca-certificates gnupg
            # echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
            # sudo apt-get update && sudo apt-get install -y google-cloud-sdk google-cloud-cli kubectl google-cloud-cli-gke-gcloud-auth-plugin
            # sudo apt upgrade -y
            # sudo apt dist-upgrade -y

            # sleep 30

            gcloud container clusters get-credentials ${{ inputs.cluster_name }} --region ${{ inputs.region }} --project ${{ inputs.project_name }}
            
            sleep 25

            cat <<EOF | kubectl apply -f -
            apiVersion: v1
            kind: Namespace
            metadata:
              name: test

EOF

            # kubectl create ns test
            # kubectl create ns argocd

            # kubectl create deployment nginx-deployment --image=nginx --replicas=3 -n test
            # kubectl expose deployment nginx-deployment --type=LoadBalancer --name=nginx-service --port=80 --target-port=80 --namespace=test --annotations cloud.google.com/load-balancer-type=Internal


             sleep 75

            # kubectl -n test get svc nginx-service -o jsonpath="{.status.loadBalancer.ingress[0].ip}" > /tmp/load_balancer_ip.txt
          '
          # LOAD_BALANCER_IP=$(gcloud compute ssh --zone "${{ inputs.region }}-a" "gke-jump-${{ inputs.cluster_name }}" --project "${{ inputs.project_name }}" --command "cat /tmp/load_balancer_ip.txt")
          # echo "LOAD_BALANCER_IP=$LOAD_BALANCER_IP" >> $GITHUB_ENV

          # echo $LOAD_BALANCER_IP
